-   doc: 'Column Name from trinity_prod_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily: DATE Min Value: 2021-11-25, Max Value: today, Frequency: daily'
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: The user is physically located in the store/outlet {store}. Take this information into account, but keep in mind, that the user can be ask about other outlets in other geographies, which has different IDs and location parameters
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: While calculating below KPIs, please ALWAYS use the following tables - 
        Sales - Table - trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw
        Sales Volume - Table - trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw
        TOOS% - trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_daily_aj_v3
        COOS% - trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_daily_aj_v3
        LOOS% - trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_daily_aj_v3
        POOS% - trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_daily_aj_v3
        Display Compliance % - trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_week_aj_v3
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        CRITICAL WALMART FILTERING RULE: This is a MANDATORY business rule that MUST be applied in ALL SQL queries.
        
        When generating SQL queries involving Walmart (RETAILER_ID ILIKE '%WALMART%'), you MUST ALWAYS include these filters:
        1. WHERE RETAILER_ID ILIKE '%WALMART%' 
        2. AND UPPER(region) NOT IN ('55 - RETAIL REGION 55', '99 - RETAIL REGION 99') 
        3. AND UPPER(region) IS NOT NULL
        
        This applies to:
        - Any KPI calculation for Walmart (sales, OOS, display compliance, etc.)
        - Any query where user mentions "walmart", "Walmart stores"
        - Any analysis involving Walmart data
        
        NEVER generate a Walmart query without these region exclusions. This is a data quality requirement.

        Never use "Like" condition for filtering. Always use "iLike" condition for filtering only if filtering is required for fuzzt matching
        
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |- 
        1. If there is an ask to calculate out of stock percentage or OOS or out of stock, please use below formula:
        SELECT
            ROUND(SUM(agg_complete_oos) / SUM(agg_sales), 3) AS Complete_OOS,
            ROUND(SUM(agg_phantom_oos) / SUM(agg_sales), 3) AS Phantom_OOS,
            ROUND((SUM(agg_complete_oos) + SUM(agg_phantom_oos)) / SUM(agg_sales), 3) AS Total_OOS,
            ROUND(SUM(agg_low_oos) / SUM(agg_sales), 3) AS Low_Stock
        FROM
            trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_daily_pvm_aj_v3 daily
        Always use the above mentioned formula to calculate OOS% or OOS or out of stock % or out of stock. Do not use any other formula and do not come up with any new formula on your own.

        2. If there is an ask to calculate OOS opportunity, please use below formulae:
            SELECT
                ROUND(SUM(master_rpc_week.agg_complete_opp + master_rpc_week.agg_phantom_opp), 1) as Total_OOS_Opportunity, 
                ROUND(SUM(master_rpc_week.agg_low_opp), 1) as Low_OOS_Opportunity, 
                ROUND(SUM(master_rpc_week.agg_complete_opp), 1) as Complete_OOS_Opportunity, 
                ROUND(SUM(master_rpc_week.agg_phantom_opp), 1) as Phantom_OOS_Opportunity       
            FROM 
                trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_daily_pvm_aj_v3 

        3. Always use the table trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_daily_pvm_aj_v3 daily to calculate Out of stock percentages;
    sql_roles:
    - admin_role
    kpi_type: sales_execution   
-   doc: |-
        Calculation of KPIs like sales, out of stock, displat compliance, broker related metrics, growth related metrics, etc.
        1. If user has not mentioned a time frame for the query, then conduct the analysis for the current year (YTD)
        2. If the user is asking data (like sales, growth, OOS, Display compliance, Opporutunity etc.) for entire year like 2025, then do not construct SQL query to generate the data at month level or day level or week level.
        3. If the user is asking data (like sales, growth, OOS, Display compliance, Opporutunity etc.) for the specific retailer like "Walmart", then do not construct SQL query to generate the data at store level/outlet level.
        4. If the user is asking data (like sales, growth, OOS, Display compliance, Opporutunity etc.) for the specific Brand like "Lysol", then do not construct SQL query to generate the data at product/product description level.
        5. Always refer to the user ask around aggrgeation of data and accordingly construct the SQL query. Do not provide additional information like ranking of products/store ids etc. If Total is asked, then don't include information around mean, highest, lowest etc.
        6. If month on month growth is asked for an year, then also generate the sales for the previous year's last month for comparsion. 
        7. If growth is asked for any KPI, then pick similar time periods for comparison. For eq. If sales YTD growth for Walmart is asked for 2025. If current month in 2025 is that of August, do comparison for (Jan 2024 - Aug 2024) amd (Jan 2025 - Aug 2025).
    sql_roles:
    - admin_role
    kpi_type: sales_execution 
-   doc: |-
        1. If there is an ask to check planned display, promotions, activations, please use this table: trinity_prod_domain_sales.smart_exec_us_gold.fact_display_compliance_selection.
        2. If there is an ask to calculate display compliance please use formula: SUM(agg_total_compliance_hybrid) / NULLIF(SUM(agg_sales_dp_hybrid), 0) from trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_week_aj_v3
        3. If there is an ask to calculate number of displays (or number of planned displays), please use formula: 
            COUNT(DISTINCT CASE WHEN agg_total_compliance_hybrid <> 0 THEN activity_name END)
            from trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_week_aj_v3
        4. If there is an ask to calculate number of outlets with display, please use formula: COUNT(DISTINCT fact.RETAILER_OUTLET_ID) AS OUTLETS_WITH_DISPLAYS FROM
        trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_week_aj_v3 fact
    sql_roles:
    - admin_role
    kpi_type: sales_execution    
-   doc: |-
        If there is an ask to calculate broker related tasks or activities, please use formula: 
        WITH broker_tasks AS (
            SELECT *,
                CASE 
                WHEN DATE_DIFF(action_date, row_creation_time) < 0 
                    OR DATE_DIFF(action_date, row_creation_time) > 7 THEN 'remove'
                ELSE 'keep'
                END AS row_consider
            FROM trinity_prod_domain_sales.smart_exec_us_gold.kpi_prioritization_all_broker_tasks
            ),
        valid_tasks AS (
            SELECT * FROM broker_tasks WHERE row_consider = 'keep'
            ),
        classified_tasks AS (
            SELECT a.*,
                    CASE 
                    WHEN b.ACTIVITY_TYPE = 'Display Replenishment' THEN 'remove'
                    ELSE 'keep'
                    END AS row_activity_consider
            FROM valid_tasks a
            LEFT JOIN (
                SELECT DISTINCT ACTIVITY_NAME, ACTIVITY_TYPE 
                FROM trinity_dev_domain_sales.smart_exec_us_gold.vw_fact_rpc_outlet_day_display
            ) b
                ON UPPER(a.display_name) = UPPER(b.ACTIVITY_NAME)
            )
        SELECT COUNT(DISTINCT broker_unique_recommendation_id) AS planned_activities
            FROM classified_tasks
            WHERE row_activity_consider = 'keep'
            AND retailer_outlet_id = 'store_id'
            AND DATE_ADD(DATE(row_creation_time), 1) BETWEEN 'Start_date' AND 'End_date'
            AND reckitt_product_code in (select distinct reckitt_product_code from trinity_prod_domain_sales.smart_exec_us_gold.dim_product where upper(dim_product.brand_name)="Brand_Name")
            AND CONCAT(retailer_outlet_id, DATE_ADD(DATE(row_creation_time), 1)) IN (
                SELECT CONCAT(retailer_outlet_id, DATE_ADD(DATE(row_creation_time), 1))
                FROM classified_tasks
                WHERE row_activity_consider = 'keep'
                AND VISIT_FLAG = 1
                AND retailer_outlet_id = 'store_id'
                AND DATE_ADD(DATE(row_creation_time), 1) BETWEEN 'Start_date' AND 'End_date'
            );
        Always remember to add this important condition in the query with Where filter -
            "CONCAT(retailer_outlet_id, DATE_ADD(DATE(row_creation_time), 1)) IN (
                SELECT CONCAT(retailer_outlet_id, DATE_ADD(DATE(row_creation_time), 1))
                FROM classified_tasks
                WHERE row_activity_consider = 'keep'
                AND VISIT_FLAG = 1
                AND retailer_outlet_id = 'store_id'
                AND DATE_ADD(DATE(row_creation_time), 1) BETWEEN 'Start_date' AND 'End_date'"
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        If there is an ask to calculate broker visits, please use formula: 
        WITH broker_tbl_action_case AS (
            SELECT *,
                CASE  
                    WHEN DATE_DIFF(action_date, row_creation_time) < 0
                    OR DATE_DIFF(action_date, row_creation_time) > 7 
                        THEN 'remove' 
                    ELSE 'keep' 
                END AS row_consider
            FROM trinity_prod_domain_sales.smart_exec_us_gold.kpi_prioritization_all_broker_tasks
        ), 

        broker_tbl_action_mod AS (
            SELECT * 
            FROM broker_tbl_action_case 
            WHERE row_consider = 'keep'
        ), 
        broker_tbl_activity_type AS (
            SELECT 
                a.*, 
                CASE  
                    WHEN b.ACTIVITY_TYPE IN ('Display Replenishment') 
                        THEN 'remove' 
                    ELSE 'keep' 
                END AS row_activity_consider 
            FROM broker_tbl_action_mod AS a
            LEFT JOIN (
                SELECT DISTINCT ACTIVITY_NAME, ACTIVITY_TYPE 
                FROM trinity_dev_domain_sales.smart_exec_us_gold.vw_fact_rpc_outlet_day_display
            ) AS b 
                ON UPPER(a.display_name) = UPPER(b.ACTIVITY_NAME)
        )

        SELECT COUNT(DISTINCT outlet_date) AS visits
        -- Combining visit date and action date with outlet ID to get unique dates for each outlet
        FROM (

            SELECT CONCAT(retailer_outlet_id, DATE(action_date)) AS outlet_date
            FROM broker_tbl_activity_type
            WHERE row_activity_consider = 'keep' 
            AND action_date IS NOT NULL AND  DATE_ADD(DATE(row_creation_time), 1) BETWEEN 'start_date' AND 'end_date'
            AND retailer_outlet_id = 'store_id' 
            AND retailer_outlet_id IN (
                SELECT DISTINCT RETAILER_OUTLET_ID
                FROM trinity_prod_domain_sales.smart_exec_us_gold.dim_outlet
                WHERE RETAILER_ID ILIKE '%retailer_id%'
                AND STATE_CODE = 'state_code'
                AND UPPER(region) NOT IN ('55 - RETAIL REGION 55', '99 - RETAIL REGION 99')
                AND UPPER(region) IS NOT NULL )
        ) AS combined;
        Always put filter for start date and end date of broker visit on DATE_ADD(DATE(row_creation_time), 1) eq - DATE_ADD(DATE(row_creation_time), 1) BETWEEN 'start_date' AND 'end_date'
        While calculating YTD, please refer to daily_fact tables to get the maximum date. 
    sql_roles:
    - admin_role
    kpi_type: sales_execution    
-   doc: |-
        If there is an ask to calculate task completion rate for brokers, please use formula:
        WITH numerator AS (
            SELECT COUNT(broker_unique_recommendation_id) AS tasks_completed
            FROM trinity_prod_domain_sales.smart_exec_us_gold.kpi_prioritization_all_broker_tasks
            WHERE retailer_outlet_id = "store_id"
            AND actioned_flag = 1
            AND visit_flag = 1
            AND DATE(row_creation_time) BETWEEN 'Start_date' AND 'End_date'
            AND reckitt_product_code in (select distinct reckitt_product_code from trinity_prod_domain_sales.smart_exec_us_gold.dim_product where upper(dim_product.brand_name)="Brand_Name")
        ),
        denominator AS (
            SELECT COUNT(broker_unique_recommendation_id) AS tasks_assigned
            FROM trinity_prod_domain_sales.smart_exec_us_gold.kpi_prioritization_all_broker_tasks
            WHERE retailer_outlet_id = "store_id"
            AND DATE(row_creation_time) BETWEEN 'Start_date' AND 'End_date'
            AND reckitt_product_code in (select distinct reckitt_product_code from trinity_prod_domain_sales.smart_exec_us_gold.dim_product where upper(dim_product.brand_name)="Brand_Name")
            AND CONCAT(retailer_outlet_id, DATE(row_creation_time)) IN (
                SELECT CONCAT(retailer_outlet_id, DATE(row_creation_time))
                FROM trinity_prod_domain_sales.smart_exec_us_gold.kpi_prioritization_all_broker_tasks
                WHERE VISIT_FLAG = 1
                    AND retailer_outlet_id = "store_id"
                    AND DATE(row_creation_time) BETWEEN 'Start_date' AND 'End_date'
            )
        )
        SELECT 
            n.tasks_completed,
            d.tasks_assigned,
            CASE 
                WHEN d.tasks_assigned = 0 THEN 0
                ELSE ROUND(CAST(n.tasks_completed AS DECIMAL) / d.tasks_assigned, 4)
            END AS task_completion_rate
        FROM numerator n
        CROSS JOIN denominator d;
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        If there is an ask to calculate visit compliance rate for brokers, please use formula:
        WITH numerator AS (
            -- Outlet-Weeks where visit happened
            SELECT 
                COUNT(DISTINCT CONCAT(retailer_outlet_id, "_", 
                DATE_SUB(DATE_ADD(DATE(row_creation_time), 1), DAYOFWEEK(DATE_ADD(DATE(row_creation_time), 1)) - 1)
                )) AS visit_count
            FROM trinity_prod_domain_sales.smart_exec_us_gold.kpi_prioritization_all_broker_tasks
            WHERE (actioned_flag = 1 OR VISIT_FLAG = 1)
                AND retailer_outlet_id = 'store_id'
                AND DATE_ADD(DATE(row_creation_time), 1) BETWEEN 'Start_date' AND 'End_date'
        ),
        denominator AS (
            -- Outlet-Weeks where lead was shared
            SELECT 
                COUNT(DISTINCT CONCAT(retailer_outlet_id, "_", 
                DATE_SUB(DATE_ADD(DATE(row_creation_time), 1), DAYOFWEEK(DATE_ADD(DATE(row_creation_time), 1)) - 1)
                )) AS total_count
            FROM trinity_prod_domain_sales.smart_exec_us_gold.kpi_prioritization_all_broker_tasks
            WHERE retailer_outlet_id iLIKE 'store_id'
                AND DATE_ADD(DATE(row_creation_time), 1) BETWEEN 'Start_date' AND 'End_date'
        )
        SELECT 
            n.visit_count AS numerator,
            d.total_count AS denominator,
            ROUND((n.visit_count * 100.0) / d.total_count, 2) AS visit_compliance_rate_percent
        FROM numerator n
        CROSS JOIN denominator d;
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: NEVER join trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw daily table with trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_week_excl_ntr_vw weekly table on RETAILER_OUTLET_ID, as it creates a very inefficient query
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |- 
        If it's necessary, use current date, but ONLY for the daily sales from trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw: {today_date}.
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: Week for the any analysis starts at Sunday, so the correct week start date calculation for trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw will be DATE_SUB(DATE_TRUNC("WEEK", `DATE`), 1)
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: Do not use INTERVAL functions.
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        User may use shorthand time expressions, such as 'LY (last year)','YTD (year-to-date)', 'MTD (month-to-date)', 'QTD (quarter-to-date)', 'WTD (week-to-date)', 'MAT (moving annual total)', 'L3M (last 3 months)', 'H1 (first half of the year)', 'H2 (second half of the year)', MOM (Month on Month), YoY (Year on Year).
        - When the user asks for YTD metrics (sales, gross sales, growth, performance, etc.):  
        - While constructing query for time period comparisions or when constructing query for YTD, QTD, MTD, WTD (week till date), always get the dates as well in final data table for user reference
        - Always ensure equal date ranges when comparing current year/month/quarter data with previous year/month/quarter data for any metric like YTD, MTD, QTD, or other custom periods. 
        - Use the maximum available date (_max_date) from the fact table as the cutoff point:
          - For YTD: Current year range = DATE_TRUNC('year', _max_date) to _max_date;
                     Previous year range = DATE_TRUNC('year', _max_date - INTERVAL '1 year') to _max_date - INTERVAL '1 year'.
                     When a comparison is asked for YOY, use the same date range for current year and previous years
                     For an illustration, if YTD sales growth is asked, please refer to below query:
                     WITH ytd_dates AS (
                    SELECT
                        DATE_TRUNC('year', MAX(DATE)) AS current_year_start,
                        MAX(DATE) AS current_year_end,
                        DATE_TRUNC('year', MAX(DATE) - INTERVAL '1 year') AS previous_year_start,
                        MAX(DATE) - INTERVAL '1 year' AS previous_year_end
                    FROM trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw
                ),
                ytd_sales AS (
                    SELECT
                        'Current Year' AS period,
                        SUM(SALES_VALUE) AS total_sales
                    FROM trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw rpc
                    CROSS JOIN ytd_dates
                    WHERE rpc.DATE BETWEEN ytd_dates.current_year_start AND ytd_dates.current_year_end
                    AND prod.lob <> 'NTR'
                    UNION ALL
                    SELECT
                        'Previous Year' AS period,
                        SUM(SALES_VALUE) AS total_sales
                    FROM trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw rpc
                    CROSS JOIN ytd_dates
                    WHERE rpc.DATE BETWEEN ytd_dates.previous_year_start AND ytd_dates.previous_year_end
                    AND prod.lob <> 'NTR'
                )
                SELECT
                    current_year.total_sales AS current_year_sales,
                    previous_year.total_sales AS previous_year_sales,
                    ROUND(
                        (current_year.total_sales - previous_year.total_sales) / NULLIF(previous_year.total_sales, 0) * 100, 2
                    ) AS sales_growth_percentage
                FROM
                    (SELECT total_sales FROM ytd_sales WHERE period = 'Current Year') current_year,
                    (SELECT total_sales FROM ytd_sales WHERE period = 'Previous Year') previous_year;
                    
          - For MTD: Current month range = DATE_TRUNC('month', _max_date) to _max_date;
                     Previous month range (while calculatio of month on month) = DATE_TRUNC('month', ADD_MONTHS(_max_date, -1)) to ADD_MONTHS(_max_date, -1) 
                     Previous year same month range = DATE_TRUNC('month', ADD_MONTHS(_max_date, -12)) to ADD_MONTHS(_max_date, -12)
                     Always use the same date range for previous month or same month previous year while comparing with current month MTD 
          - For QTD: Always use below formula to calculate QTD for this quarter and for previous quarter for comparison
                     Current quarter range = DATE_TRUNC('quarter', _max_date) to _max_date;
                     Previous quarter range (for QoQ comparison or QTD comparison) = DATE_TRUNC('QUARTER', ADD_MONTHS(_max_date, -3)) to ADD_MONTHS(_max_date, -3) 
                     When a comparison is asked for QoQ, use the same date range for current quarter and previous quarters
        While constructing query for time period comparisions or when constructing query for YTD, QTD, MTD, WTD (week till date), get the dates as well in final data table for user reference
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: If the user asks any KPI like sales, out of stock, display compliance, opportunity etc. for an year/quarter/Semester etc, don't give answers by month unless explicitly asked. Always give the answer for entire period (be it year, quarter, etc.) as asked by the user in the question. If user is asking for the KPI at retailer level and brand level, don't break down the analysis by store level or product level unless the user asks explicitly. 

    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |- 
        last month: 
        - When the user mentions "last month", always refer to the previous full month based on latest date in the table. For example, if the latest date in the table is 04/15/2025, the last month would be from 03/01/2025, to 03/31/2025.
        - SQL expression to use for this: `DATE_ADD(DATE_TRUNC('MONTH', MAX(your_date_column)),-1) AS last_month_end, ADD_MONTHS(DATE_TRUNC('MONTH', MAX(your_date_column)),-1) AS last_month_start`
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
        
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |- 
        last week:
        - When the user mentions "last week", always refer to the previous full week based on latest date in the table. For example, if the latest date in the table is 04/15/2025, the last week would be from 04/06/2025 to 04/12/2025.
        - SQL expression to use for this: `DATE_SUB(DATE_TRUNC('week', MAX(your_date_column)), 1) AS last_week_start, DATE_ADD(last_week_start, 7) AS last_week_end`
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |- 
        last year
        - When the user mentions "last year", always refer to the previous full year based on latest date in the table. For example, if the latest date in the table is 04/15/2025, the last year would be from 01/01/2024 to 12/31/2024.
        - SQL expression to use for this: `DATE_TRUNC('YEAR', DATE_SUB(max(your_date_column), 365)) AS last_year_start, DATE_SUB(DATE_TRUNC('YEAR', max(your_date_column)), 1) AS last_year_end `
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        If the user emphasizes week days instead of weekends, then they are interested in Mondays to Fridays.
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        - When user mentions "currently" or "ongoing", always use the latest date in the table as the current date.
        - SQL expression to use for this: `max(your_date_column) AS min_date, max(your_date_column) AS max_date`
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: Do not confuse 'activities' with 'activations'. 'Activities' refers to broker tasks and activities, while 'activation' refers to promotions or displays.
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: When user refers to a retailer as a whole, such as 'Walmart' as a whole, or 'Kroger' as a whole, please aggregate values across all walmart stores from trinity_prod_domain_sales.smart_exec_us_gold.dim_outlet and do not group by individual stores.
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        When the users asks about planned displays or current items that are on display the information is contained in the fact_display_compliance_selection table. fact_display_compliance_selection contains the display name (which is the same as Promo name) the promo start date, the promo end date, the RETAILER_OUTLET_IDs for the display and the RECKITT_PRODUCT_CODE that will be on the display.
        fact_rpc_outlet_week_excl_ntr_vw contains historical data regarding the display compliance and will flag if the broker has been to the store and confirmed that the display is present. This table historical only so cannot be used to answer questions about planned future displays.
        When the users ask about display compliance, we need provide data from trinity_dev_domain_sales.smart_exec_us_gold.tmp_fact_rpc_outlet_week_aj_v3
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        When a user asks about a specific display using keywords, apply an OR filter to check if the keyword appears in either the PROMO_NAME or BRAND_NAME columns in the trinity_dev_domain_sales.smart_exec_us_gold.fact_display_compliance_selection table.
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        When a user asks about display compliance for a specific display using keyword, check if the keyword appears in the ACTIVITY_NAME in trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_week_excl_ntr_vw table.
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        Whenever a user asks to calculate sales, growth, out of stock (OOS), display compliance related metrics, always exclude "NTR" (nutrition) line of business referring the below logic - lob <> "NTR" using table trinity_prod_domain_master.master_data_gold.dimension_product. If no time period is mentioned by the user in the query, then calculate the KPI for the current year (YTD).
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        Business Logic for Sales vs Gross Sales
        Definitions:
        A. Sales → This includes metrics like sales_volume, sales_value, and brand performance based on sales performance.
        When a user query contains the words: "sales" without the words "gross"  → Always map to trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw.
        B. Gross Sales → Refers only to Gross sales, stored in the trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance.
        This includes metrics like gross_sales
        When a user query contains the words:
        "gross sales" → Always map to trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance.

        Rules for Query Generation:
        1. If the user query says "sales" and does not specify "gross", use trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw.
        2. If the user explicitly says "gross sales", use trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance.
        3. For brand performance metrics (growth, top selling brand, top performing brand, etc.), use use trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw.
        Example Interpretations:
        1. "What is the sales for Lysol in Walgreens for 2024?" → Use trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw.
        2. "What is the gross sales for Lysol in Walgreens for 2024?" → Use trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance.
        3. "Top performing brand in sales for 2023" → Use trinity_dev_domain_sales.smart_exec_us_gold.fact_rpc_outlet_daily_excl_ntr_vw.
        4. "YOY/YTD growth for Lysol" → Use trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance.
        5. "YOY/YTD growth in Gross Sales for Lysol" -Use trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance.?
    sql_roles:
    - admin_role
    kpi_type: finance
-   doc: |-
        Financial Metrics Comparison:
        
        When the query is around financial metrics - Gross Sales, Net Revenue, Trade Investment or Gross Margin, always use trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance.:
        - Gross Sales: trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance
        - Net Revenue: trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance 
        - Trade Investment: trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance
        - Gross Margin: trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance
        - Gross Margin % - This metric is calculated using formulae - (Gross Margin/ Net Revenue). While calculating Gross Margin %, first calculate Gross Margin and Net revenue separately with required filters anc conditions and then apply the formulae - Gross Margin/ Net Revenue
        If a user asks gross margin or anything around gross margin, always generate SQL to caculate both gross margin and gross margin %
        Never join table trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance with any other tables as it is not applicable
        If the user asks any KPI like growth, YoY growth, MoM growth, QoQ growth, YTD growth, brand performance on these finance FPIs - gross sales, net revenue, trade investment or gross margin, always use the table trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance
        Use this formulae to calculate the max date when you have to calculate YTD/QTD/MTD for finance related FPIS -
        SELECT
            DATE_TRUNC('year', MAX(Year_Month)) AS current_year_start,
            MAX(Year_Month) AS current_year_end
            FROM trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance

        Never use "Like" condition for filtering. Always use "iLike" condition only if filtering is required for fuzzy match

        Whenever a user asks about gross margin, trade investment, net revenue, or gross sales, detect (case-insensitive, fuzzy-tolerant for small typos, preferring longest spans) any mention of these retailers — Amazon, Caribbean, Closeout, Hardware, House Account, Institutional/Hospital, Price Smart, Professional, Target, Total Club - BJS, Total Club - COSTCO, Total Club - SAMS, Total Dollar - Other, Total Dollar - DG, Total Dollar - Family, Total Drug - Other, Total Drug - CVS, Total Drug - Walgreens, Total Food - Other, Total Food - Albertsons, Kroger, Total Food - Publix, Unallocated, Walmart, e commerce, then filter on retailer_id using ilike condition

        When a user asks to conducte an analysis which involves comparison of a KPI against two time frames, never use LAG function while generating SQL query. Always use actual dates to generate the SQL query. 
        
        To find out top retailers, brands, segments or products, conduct sorting on actual increase/ decrease numbers rather than sorting on percent increase or percent decrease.
        
        Very Important Rule - When generating SQL query to caculate dates for previous year, month or quarter for finance KPIs (gross sales, gross margin, net revenue and trade investment), then always use "ADD_MONTHS" function to calculate the dates as the dates in finance queries spport this function

        Important Filtering Rules for Net Revenue and Trade Investment:
        When querying Net Revenue or Trade Investment tables:
        - Customer queries: MUST include filter WHERE Audit_ID = 'TURACT'
        - Brand queries: Audit_ID filter is NOT required
        - Customer & Brand queries: Audit_ID filter is NOT required
        
        Examples:
        - Customer-level: "SELECT * FROM trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance WHERE RETAILER_NAME = 'Walmart' AND Audit_ID = 'TURACT'"
        - Brand-level: "SELECT * FROM trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance WHERE BRAND_NAME = 'Mucinex'" (no Audit_ID filter needed)
        - Customer & Brand: "SELECT * FROM trinity_dev_domain_sales.smart_exec_us_gold.smex_cb_full_table_finance WHERE RETAILER_NAME = 'Walmart' AND BRAND_NAME = 'Mucinex'" (no Audit_ID filter needed)
    sql_roles:
    - admin_role
    kpi_type: finance
-   doc: |-
        When a user asks to conduct an analysis which involves comparison of a KPI against two time frames, never use LAG function while generating SQL query. Always use actual dates to generate the SQL query. 
        To find out top retailers, brands, segments or products, conduct sorting on actual increase/ decrease numbers rather than sorting on percent increase or percent decrease.
        Very Important Rule - When generating SQL query to caculate dates for previous year, month or quarter for finance KPIs (gross sales, gross margin, net revenue and trade investment), then always use "ADD_MONTHS" function to calculate the dates as the dates in finance queries support this function
    sql_roles:
    - admin_role
    kpi_type: finance
-   doc: |-
        Calculation of KPIs like gross sales, net revenue, trade investment and gross margin
        1. If user has not mentioned a time frame for the query, then conduct the analysis for the current year (YTD)
        2. If the user is asking data (like gross sales, net revenue, trade investment and gross margin etc.) for entire year like 2025, then do not construct SQL query to generate the data at month level
        4. If the user is asking data (like gross sales, net revenue, trade investment and gross margin etc.)) for the specific Brand like "Lysol", then do not construct SQL query to generate the data at product/product description level.
        5. Always refer to the user ask around aggregation of data and accordingly construct the SQL query. Do not provide additional information like ranking of products/store ids etc. If Total is asked, then don't include information around mean, highest, lowest etc.
        6. If month on month growth is asked for an year, then also generate the sales for the previous year's last month for comparison. 
        7. If growth is asked for any KPI, then pick similar time periods for comparison. For eq. If sales YTD growth for Walmart is asked for 2025. If current month in 2025 is that of August, do comparison for (Jan 2024 - Aug 2024) amd (Jan 2025 - Aug 2025).
    sql_roles:
    - admin_role
    kpi_type: finance
-   doc: |-
         Never use "Like" condition for filtering. Always use "iLike" condition for filtering only if filtering is required for fuzzt matching
    sql_roles:
    - admin_role
    kpi_type: finance
-   doc: |- 
        last month: 
        - When the user mentions "last month", always refer to the previous full month based on latest date in the table. For example, if the latest date in the table is 04/15/2025, the last month would be from 03/01/2025, to 03/31/2025.
        - SQL expression to use for this: `DATE_ADD(DATE_TRUNC('MONTH', MAX(your_date_column)),-1) AS last_month_end, ADD_MONTHS(DATE_TRUNC('MONTH', MAX(your_date_column)),-1) AS last_month_start`
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
    sql_roles:
    - admin_role
    kpi_type: finance
-   doc: |- 
        last year
        - When the user mentions "last year", always refer to the previous full year based on latest date in the table. For example, if the latest date in the table is 04/15/2025, the last year would be from 01/01/2024 to 12/31/2024.
        - SQL expression to use for this: DATE_TRUNC('YEAR', DATE_SUB(max(your_date_column), 365)) AS last_year_start, DATE_SUB(DATE_TRUNC('YEAR', max(your_date_column)), 1) AS last_year_end 
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
    sql_roles:
    - admin_role
    kpi_type: finance
-   doc: |-
        - When user mentions "currently" or "ongoing", always use the latest date in the table as the current date.
        - SQL expression to use for this: max(your_date_column) AS min_date, max(your_date_column) AS max_date
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
    sql_roles:
    - admin_role
    kpi_type: finance
-   doc: |-
        When a user asks to conduct an analysis which involves comparison of a KPI against two time frames, never use LAG function while generating SQL query. Always use actual dates to generate the SQL query. 
        To find out top retailers, brands, segments or products, conduct sorting on actual increase/ decrease numbers rather than sorting on percent increase or percent decrease.
    sql_roles:
    - admin_role
    kpi_type: sales_execution
-   doc: |-
        When a user asks to conduct an analysis which involves comparison of a KPI against two time frames, never use LAG function while generating SQL query. Always use actual dates to generate the SQL query. 
        To find out top retailers, brands, segments or products, conduct sorting on actual increase/ decrease numbers rather than sorting on percent increase or percent decrease.
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |-
        - When user mentions "currently" or "ongoing", always use the latest date in the table as the current date.
        - SQL expression to use for this: max(your_date_column) AS min_date, max(your_date_column) AS max_date
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |- 
        last year
        - When the user mentions "last year", always refer to the previous full year based on latest date in the table. For example, if the latest date in the table is 04/15/2025, the last year would be from 01/01/2024 to 12/31/2024.
        - SQL expression to use for this: DATE_TRUNC('YEAR', DATE_SUB(max(your_date_column), 365)) AS last_year_start, DATE_SUB(DATE_TRUNC('YEAR', max(your_date_column)), 1) AS last_year_end 
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |-
         Never use "Like" condition for filtering. Always use "iLike" condition for filtering only if filtering is required for fuzzt matching
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |- 
        last month: 
        - When the user mentions "last month", always refer to the previous full month based on latest date in the table. For example, if the latest date in the table is 04/15/2025, the last month would be from 03/01/2025, to 03/31/2025.
        - SQL expression to use for this: `DATE_ADD(DATE_TRUNC('MONTH', MAX(your_date_column)),-1) AS last_month_end, ADD_MONTHS(DATE_TRUNC('MONTH', MAX(your_date_column)),-1) AS last_month_start`
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |-
        When a user asks to conduct an analysis which involves comparison of a KPI against two time frames, never use LAG function while generating SQL query. Always use actual dates to generate the SQL query. 
        To find out top retailers, brands, segments or products, conduct sorting on actual increase/ decrease numbers rather than sorting on percent increase or percent decrease.
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |-
        Calculation of KPIs like gross sales, net revenue, trade investment and gross margin
        1. If user has not mentioned a time frame for the query, then conduct the analysis for the current year (YTD)
        2. If the user is asking data for entire year like 2025, then do not construct SQL query to generate the data at month level
        4. If the user is asking data for the specific Brand like "Lysol", then do not construct SQL query to generate the data at product/product description level.
        5. Always refer to the user ask around aggregation of data and accordingly construct the SQL query. Do not provide additional information like ranking of products/store ids etc. If Total is asked, then don't include information around mean, highest, lowest etc.
        6. If month on month growth is asked for an year, then also generate the sales for the previous year's last month for comparison. 
        7. If growth is asked for any KPI, then pick similar time periods for comparison. For eq. If sales YTD growth for Walmart is asked for 2025. If current month in 2025 is that of August, do comparison for (Jan 2024 - Aug 2024) amd (Jan 2025 - Aug 2025).
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |-
        Shipment Metrics Comparison:       
        When the query is around shipment metrics, always use trinity_dev_domain_sales.smart_exec_us_gold.shipment_report.:
        Never join table trinity_dev_domain_sales.smart_exec_us_gold.shipment_report with any other tables as it is not applicable
        Use this formulae to calculate the max date when you have to calculate YTD/QTD/MTD for finance related FPIS -
        SELECT
            DATE_TRUNC('year', MAX(Date)) AS current_year_start,
            MAX(Date) AS current_year_end
            FROM trinity_dev_domain_sales.smart_exec_us_gold.shipment_report

        Never use "Like" condition for filtering. Always use "iLike" condition only if filtering is required for fuzzy match
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |- 
        last month: 
        - When the user mentions "last month", always refer to the previous full month based on latest date in the table. For example, if the latest date in the table is 04/15/2025, the last month would be from 03/01/2025, to 03/31/2025.
        - SQL expression to use for this: `DATE_ADD(DATE_TRUNC('MONTH', MAX(your_date_column)),-1) AS last_month_end, ADD_MONTHS(DATE_TRUNC('MONTH', MAX(your_date_column)),-1) AS last_month_start`
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
        
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |- 
        last week:
        - When the user mentions "last week", always refer to the previous full week based on latest date in the table. For example, if the latest date in the table is 04/15/2025, the last week would be from 04/06/2025 to 04/12/2025.
        - SQL expression to use for this: `DATE_SUB(DATE_TRUNC('week', MAX(your_date_column)), 1) AS last_week_start, DATE_ADD(last_week_start, 7) AS last_week_end`
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |- 
        last year
        - When the user mentions "last year", always refer to the previous full year based on latest date in the table. For example, if the latest date in the table is 04/15/2025, the last year would be from 01/01/2024 to 12/31/2024.
        - SQL expression to use for this: `DATE_TRUNC('YEAR', DATE_SUB(max(your_date_column), 365)) AS last_year_start, DATE_SUB(DATE_TRUNC('YEAR', max(your_date_column)), 1) AS last_year_end `
        - The date column may have a different name than "your_date_column" in the table, so ensure you replace "your_date_column" with the actual column name.
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |- 
        - 'HDWE' refers to the retailer name and should be looked in retailer column
        - While filtering for column for KPI, please refer to these columns for these KPIs -
            Open_previous_month - 'Open previous month',
            Total_open -'total open',
            Op_Sh_Inv -'Open + Shipped + Invoiced',
            Open_on_hold -'Open on hold',
            Open - 'Open',
            Unplanned - 'Unplanned',
            Planned - 'Planned',
            Confirmed - 'Confirmed',
            Picked - 'Picked',
            Shipped - 'Shipped',
            Invoiced - 'Invoiced'
            Shipped_not_invoiced - 'Shipped not invoiced',
            Total_without_PF - 'Total without or w/o PF',
            Open_no_product - 'Open no product' 
        - 'Open' and 'Open Total' are different KPIs and should not be confused with the same KPI
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |- 
        - When calculating Top 5 brands/segments/products/regions etc., always use the absolute difference/numbers and not the percentage value.
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |-
        - When a user asks about KPIs from the below list, take the KPI column as is without breaking it down-
            'Open previous month' should be treated as Open_previous_month column in the dataset
            'total open' should be treated as total_open column in the dataset
            'Open + Shipped + Invoiced' or 'Open and shipped and Invoiced' should be treated as Op_Sh_Inv column in the dataset
            'Open on hold' should be treated as Open_on_hold column in the dataset     
            'Shipped not invoiced'should be treated as Shipped_not_invoiced column in the dataset
            'Total without or w/o PF'should be treated as Total_without_PF column in the dataset
            'Open no product' should be treated as Open_no_product column in the dataset
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |-
        - When a user asks about "LV sales call" the use this table - trinity_prod_domain_sales.smart_exec_us_gold.LV_sales_processed
    sql_roles:
    - admin_role
    kpi_type: shipment
-   doc: |-
        CRITICAL CONTRIBUTION RULE:
        - When a question asks for items contributing to an overall Increase or Decrease (e.g., "contribute to the overall decrease in sales"), the CTE used for final contribution calculation MUST include a WHERE clause to filter for only those items that match the overall trend (WHERE change_amount > 0 for increase, or WHERE change_amount < 0 for decrease).
        
    sql_roles:
    - admin_role
    kpi_type: sales_execution